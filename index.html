 
<!DOCTYPE html>
<html>
<head>
<title>websockets</title>
<meta charset="utf8" name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="css/indice.css" type="text/css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Temas-->
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">-->
<script>

var socket = new WebSocket("wss://localhost:9990");

function botonEntrar()
{
    var json = {id: "1", action: "login", mail: document.getElementById("correo").value, pass: document.getElementById("contra").value};
    socket.send(JSON.stringify(json));
    document.getElementById("divlogin").style.display="none";
    document.getElementById("divIni").style.display="block";
}

function volverInicio()
{
    document.getElementById("divIni").style.display="block";
    document.getElementById("estiloBusqueda").style.visibility="hidden";
    document.getElementById("retroceso").style.display="none";
    while (document.getElementById("busqueda").hasChildNodes()) {
        document.getElementById("busqueda").removeChild(document.getElementById("busqueda").firstChild);
    }
}

function cancelarProducto() //Funcion para cancelar una busqueda
{
    var json = {id: "1", action: "cancelar", name: document.getElementById("cancelar").value};
    socket.send(JSON.stringify(json));
}

function revisarProducto() //Funcion para pedir si existe el producto
{
    var json = {id: "2", action: "estado", name:  document.getElementById("comprobar").value};
    socket.send(JSON.stringify(json));
    document.getElementById("divIni").style.display="none";
    document.getElementById("busqueda").style.display="block";
    document.getElementById("retroceso").style.display="block";
}

function agregarProducto() //Funcion para agregar un producto a la lista de productos
{
    var json = {id: "3", action: "agregar", name: document.getElementById("agregar").value, web: "www.amazon.es"}; //modificar la web
    socket.send(JSON.stringify(json));
}

function confirmacionDelete()
{
    var ok = confirm("Estas seguro de que quieres borrar el elemento?");
    if (ok == true)
    {
        cancelarProducto();
        alert("Se ha borrado con éxito");
    } //end if
}

socket.onopen = function(e) {
  alert("[open] Connection established");
  //alert("Sending to server");
  //socket.send("My name is John");
};

socket.onmessage = function(event) {
  //alert(`[message] Data received from server: ${event.data}`);
  console.log(event.data);
  var mensaje = JSON.parse(event.data);
  if (mensaje.action == "delete")
  {
    alert("Hay mas de una fila por borrar");
    confirm("Seguro que quieres borrar?");
  }
  else if (mensaje.action == "insert")
  {
    alert("Se han introducido los datos correctamente!!!");
  }
  else if (mensaje.action == "update")
  {
    alert("Modificado con éxito!!!");
  }
  else if (mensaje.action == "select")
  {
  for(var i = 0; i < Object.keys(mensaje.busqueda).length; i++)
  {
    console.log(mensaje.busqueda)
  }
    alert("Ahora mismo hay estos procesos en búsqueda: ");
    var espaciado = document.createTextNode("           ");
    for(var i = 0; i < Object.keys(mensaje.busqueda.nombre).length; i++) {       //Cada elemento se coloca en un div distinto

        var div = document.createElement("div");
        div.id="estiloBusqueda";
        var nombres = document.createElement("nombre");
        nombres.style.display= "block";
        var nombre = document.createTextNode("Nombre: " + mensaje.busqueda.nombre[i]);

        nombres.appendChild(nombre);

        var estados = document.createElement("estado");
        estados.style.display= "block";
        var estado = document.createTextNode("Estado: " + mensaje.busqueda.estado[i]);
        estados.appendChild(estado);

        var tiempos = document.createElement("tiempo");
        tiempos.style.display= "block";
        var tiempo = document.createTextNode("Tiempo transcurrido: " + mensaje.busqueda.tiempo[i]);
        tiempos.appendChild(tiempo);

        var direcciones = document.createElement("direccion");
        direcciones.style.display= "block";
        var direccion = document.createTextNode("Dirección de búsqueda: " + mensaje.busqueda.recurso[i]);
        direcciones.appendChild(direccion);

        console.log(document.getElementById("busqueda").appendChild(div));

        div.appendChild(nombres);
        div.appendChild(estados);
        div.appendChild(tiempos);
        div.appendChild(direcciones);

        document.getElementById("busqueda").appendChild(div);
    }

  };
}

socket.onclose = function(event) {
  if (event.wasClean) {
    alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // e.g. server process killed or network down
    // event.code is usually 1006 in this case
    // alert('[close] Connection died');
  }
};

socket.onerror = function(error) {
  alert(`[error] ${error.message}`);
};
</script>
</head>
<body style="background-color:white"> <!-- http://www.gitmedio.com/gitmedio/codigo-en-php-y-mysql-sistema-de-autenticacion/ -->

<!--Pagina de login -->
    <div id="divlogin">
        <div class="ContentForm">
            <!--<form action="" method="get" name="FormEntrar"> -->
                    <div style="margin: 40px 0px 0px -28%">
                      <input type="email" name="correo" placeholder="example@example.com" id="correo" size="30" required>
                    </div>
                    <div style="margin: 10px 0px 0px -28%">
                      <input type="password" name="contra" placeholder="******" id="contra" size="30" required>
                    </div>
                    <br>
                    <button id="login" type="" onclick="botonEntrar()">Entrar</button>
                    <div class="opcioncontra"><a href="">Olvidaste tu contraseña?</a></div>
            <!--</form>-->
        </div>
    </div>
<!--Fin login -->
<input type=image src="flecha.png" id="retroceso" width="50" height="50" onclick="volverInicio()"/>
    <div id="divIni"> <!-- Pagina del cliente -->
    <h1>Funciones disponibles:</h1>
        <div class="divsConsulta">
            1. Introduce el nombre del producto que quieras empezar a buscar: <br style="margin-bottom:10px">
            <input type="textfield" id="agregar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Nuevo producto" onclick="agregarProducto()"/>
        </div>
        <div class="divsConsulta">
            2. Introduce el producto a cancelar: <br style="margin-bottom:30px">
            <input type="textfield" id="cancelar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Cancelar producto" onclick="confirmacionDelete()"/>
        </div>
        <div class="divsConsulta">
            3. Introduce el nombre del producto que quieres revisar: <br style="margin-bottom:30px">
            <input type="textfield" id="comprobar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Comprobar producto" onclick="revisarProducto()"/>
        </div>
    </div>
    <div id="busqueda">
    <!--Aqui van los elementos de la busqueda-->
    </div>
</body>
</html>
