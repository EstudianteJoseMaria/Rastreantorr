<!DOCTYPE html>
<html>
<head>
<title>websockets</title>
<meta charset="utf8" />
<script>
let socket = new WebSocket("wss://127.0.0.1:9990");

function volverInicio()
{
    document.getElementById("divIni").style.visibility="visible";
    document.getElementById("busqueda").style.visibility="hidden";
    document.getElementById("retroceso").style.visibility="hidden";
}

function cancelarProducto() //Funcion para cancelar una busqueda
{
    var json = {id: "1", action: "cancelar", name: document.getElementById("cancelar").value};
    socket.send(JSON.stringify(json));
}

function revisarProducto() //Funcion para pedir si existe el producto
{
    var json = {id: "2", action: "estado", name:  document.getElementById("comprobar").value};
    socket.send(JSON.stringify(json));
    document.getElementById("divIni").style.visibility="hidden";
    document.getElementById("busqueda").style.visibility="visible";
    document.getElementById("retroceso").style.visibility="visible";
}

function agregarProducto() //Funcion para agregar un producto a la lista de productos
{
    var json = {id: "3", action: "agregar", name: document.getElementById("agregar").value, web: "www.amazon.es"}; //modificar la web
    socket.send(JSON.stringify(json));
}

function confirmacionDelete()
{
    var ok = confirm("Estas seguro de que quieres borrar el elemento?");
    if (ok == true)
    {
        cancelarProducto();
        alert("Se ha borrado con éxito");
    } //end if
}

socket.onopen = function(e) {
  alert("[open] Connection established");
  //alert("Sending to server");
  //socket.send("My name is John");
};

socket.onmessage = function(event) {
  //alert(`[message] Data received from server: ${event.data}`);
  console.log(event.data);
  var mensaje = JSON.parse(event.data);
  if (mensaje.action == "delete")
  {
    alert("Hay mas de una fila por borrar");
    confirm("Seguro que quieres borrar?");
  }
  else if (mensaje.action == "insert")
  {
    alert("Se han introducido los datos correctamente!!!");
  }
  else if (mensaje.action == "update")
  {
    alert("Modificado con éxito!!!");
  }
  else if (mensaje.action == "select")
  {
    alert("Ahora mismo hay estos procesos en búsqueda: ");

    for(var i = 0; i < mensaje.busqueda.length; i++) {       //Cada elemento se coloca en un div distinto

        var div = document.createElement("div");
        var nombres = document.createElement("nombre");
        var nombre = document.createTextNode(mensaje.busqueda.nombre[i]);
        nombres.appendChild(nombre);
        var estados = document.createElement("estados");
        var estado = document.createTextNode(mensaje.busqueda.estado[i]);
        estados.appendChild(estado);
        var tiempos = document.createElement("tiempo");
        var tiempo = document.createTextNode(mensaje.busqueda.tiempo[i]);
        tiempos.appendChild(tiempo);
        var recursos = document.createElement("recursos");
        var recurso = document.createTextNode(mensaje.busqueda.recurso[i]);
        recursos.appendChild(recurso);
        div.appendChild(nombres);
        div.appendChild(estados);
        div.appendChild(tiempos);
        div.appendChild(recursos);

        document.getElementById("busqueda").appendChild(div);

    }
    
  };
}

socket.onclose = function(event) {
  if (event.wasClean) {
    alert(`[close] Connection closed cleanly, code=${event.code} reason=${event.reason}`);
  } else {
    // e.g. server process killed or network down
    // event.code is usually 1006 in this case
    // alert('[close] Connection died');
  }
};

socket.onerror = function(error) {
  alert(`[error] ${error.message}`);
};
</script>
</head>
<body style="background-color:white">
<input type=image src="flecha.png" id="retroceso" width="50" height="50" style="position:absolute; visibility:hidden" onclick="volverInicio()"/>
    <div style = "padding-left: 50px; display: block;" id="divIni">
    <h1>Funciones disponibles:</h1>
        <div style="border: 2px solid #ccc;width: 365px; height:150px; margin-bottom: 20px; margin-left:8%; padding: 2% 0% 0% 1%; float:left;">
            1. Introduce el nombre del producto que quieras empezar a buscar: <br style="margin-bottom:30px">
            <input type="textfield" id="agregar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Nuevo producto" onclick="agregarProducto()"/>
        </div>
        <div style="border: 2px solid #ccc;width: 370px; height:150px; margin-bottom: 20px; margin-left:8%; padding: 2% 0% 0% 1%; float:left;">
            2. Introduce el producto a cancelar: <br style="margin-bottom:30px">
            <input type="textfield" id="cancelar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Cancelar producto" onclick="confirmacionDelete()"/>
        </div>
        <div style="border: 2px solid #ccc;width: 400px; height:150px; margin: 0px 0px 20px 8%; padding: 2% 0% 0% 1%; float:left;">
            3. Introduce el nombre del producto que quieres revisar: <br style="margin-bottom:30px">
            <input type="textfield" id="comprobar" placeholder="Introduce el nombre del producto"/>
            <input type="button" value="Comprobar producto" onclick="revisarProducto()"/>
        </div>
    </div>
    <div id="busqueda" style="border: 2px solid #ccc; width: 600px; height:150px; margin: 0px 0px 0%  30%;padding: 20px 0px 0px 50px; position:absolute; top:35%; visibility:hidden"><text>"Solo mostrarse al hacer una búsqueda"<br><nombre> nombres </nombre><br> <b>Estado:</b> pendiente <br> <b>Tiempo transcurrido:</b> 20º 50' 20'' <br> <b>Dirección de búsqueda:</b> www.amazon.es</text>
    </div>
</body>
</html>
